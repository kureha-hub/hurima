<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HurimaApp</title>
<%= stylesheet_link_tag 'show', media: 'all' %>
<%= stylesheet_link_tag 'reset', media: 'all' %>
<meta name="csrf-token" content="<%= form_authenticity_token %>">
</head>
<body>
    <!--„Éò„ÉÉ„ÉÄ„Éº-->
    <header class="header_tweet">
    <div class="container inner">
        <!-- „É≠„Ç¥ + Ê§úÁ¥¢„Éê„Éº -->
        <div class="area_logo_header">
        <a class="logo" href="#">
            <img src="/assets/hurima_logo.png" alt="„É≠„Ç¥" class="header-logo" />
        </a>

        <!-- Ê§úÁ¥¢„Éê„Éº -->
        <div class="search-bar">
            <%= form_tag({controller: "tweets", action: "index"}, method: :get) do %>
            <%= label_tag :search, "Ê§úÁ¥¢" %>
            <%= text_field_tag :search, nil, placeholder: "Ê§úÁ¥¢", class: "search-input" %>
            <%= submit_tag 'Ê§úÁ¥¢', class: "search-submit" %>
            <% end %>
        </div>
        </div>
        

        <!-- „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
        <nav class="area_nav_header">
        <ul class="list_nav_header">
            <!-- „Éõ„Éº„É† -->
            <li class="home">
            <%= link_to tweets_path do %>
                <svg class="icon home-icon" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24">
                <path d="M12 6.453l9 8.375v9.172h-6v-6h-6v6h-6v-9.172l9-8.375zm12 5.695l-12-11.148-12 11.133 1.361 1.465 10.639-9.868 10.639 9.883 1.361-1.465z"/>
                </svg>
            <% end %>
            </li>

            <!-- „ÅÑ„ÅÑ„Å≠ -->
            <li class="favorite">
            <%= link_to user_path(current_user, anchor: "likes") do %>
                <svg class="icon nav-heart-icon" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24">
                <path d="m12 5.72c-2.624-4.517-10-3.198-10 2.461 0 3.725 4.345 7.727 9.303 12.54.194.189.446.283.697.283s.503-.094.697-.283c4.977-4.831 9.303-8.814 9.303-12.54 0-5.678-7.396-6.944-10-2.461z" />
                </svg>
            <% end %>
            </li>

            <!-- „É¶„Éº„Ç∂„Éº -->
            <li class="user-dropdown">
            <input type="checkbox" id="toggle-user-menu" hidden>
            <label for="toggle-user-menu" class="user-icon-wrapper">
                <svg class="icon user-icon" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24">
                <path d="M19 7.001c0 3.865-3.134 7-7 7s-7-3.135-7-7c0-3.867 3.134-7.001 7-7.001s7 3.134 7 7.001zm-1.598 7.18c-1.506 1.137-3.374 1.82-5.402 1.82-2.03 0-3.899-.685-5.407-1.822-4.072 1.793-6.593 7.376-6.593 9.821h24c0-2.423-2.6-8.006-6.598-9.819z"/>
                </svg>
            </label>
            <ul class="dropdown-menu">
                <li><%= link_to '„Éû„Ç§„Éö„Éº„Ç∏', user_path(current_user.id) %></li>
                <li><%= link_to '„ÅÑ„ÅÑ„Å≠‰∏ÄË¶ß', likes_path %></li>
                <li><%= link_to 'ÊäïÁ®ø‰∏ÄË¶ß', tweets_path %></li>
                <li><%= button_to '„É≠„Ç∞„Ç¢„Ç¶„Éà', destroy_user_session_path, method: :delete, class: "logout-link" %></li>
            </ul>
            </li>

            <!-- Âá∫ÂìÅ -->
            <li class="btn_tweet">
            <%= link_to "Âá∫ÂìÅ", new_tweet_path, class: "btn_tweet" %>
            </li>
        </ul>
        </nav>
    </div>
    </header>

        <!-- ‚ñº„Çø„Ç∞Ê§úÁ¥¢„Éà„Ç∞„É´Ôºã„Éï„Ç©„Éº„É† -->
        <button id="toggle-tag-search" class="tag-search-toggle">„Çø„Ç∞Ê§úÁ¥¢ ‚ñº</button>

        <div id="tag-search-box" style="display: none;" class="tag-search-box">
        <%= form_tag({controller: "tweets", action: "index"}, method: :get) do %>
            <% Tag.all.each do |tag| %>
            <label class="tag-label">
                <%= check_box_tag "tag_ids[]", tag.id %>
                <%= tag.name %>
            </label>
            <% end %>
            <%= submit_tag 'Ê§úÁ¥¢', class: "tag-submit-button" %>
        <% end %>
        </div>

<!-- ÂïÜÂìÅË©≥Á¥∞ÂÖ®‰Ωì -->
<div class="tweet-detail-container">
<div class="tweet-detail-box">

    <!-- ÂïÜÂìÅÁîªÂÉè -->
    <div class="tweet-image">
    <% if @tweet.image.attached? %>
        <%= image_tag url_for(@tweet.image), alt: "ÂïÜÂìÅÁîªÂÉè", class: "product-image" %>
    <% else %>
        <%= image_tag "noimage.png", class: "product-image" %>
    <% end %>
    </div>

    <!-- ÂïÜÂìÅÊÉÖÂ†± -->
    <div class="tweet-info">
    <p><strong>ÂïÜÂìÅÂêçÔºö</strong><%= @tweet.product_name.presence || "ÔºàÊú™ÂÖ•ÂäõÔºâ" %></p>
    <p><strong>Ë¨õÁæ©ÂêçÔºö</strong><%= @tweet.lecture.presence || "ÔºàÊú™ÂÖ•ÂäõÔºâ" %></p>
    <p><strong>Ë™¨ÊòéÔºö</strong><%= simple_format(@tweet.body.presence || "ÔºàÊú™ÂÖ•ÂäõÔºâ") %></p>
    <p><strong>Âá∫ÂìÅËÄÖÔºö</strong><%= @tweet.user.email %></p>

    <!-- „ÅÑ„ÅÑ„Å≠„Éª„Ç≥„É°„É≥„ÉàÊï∞ -->
    <div class="action-row">
        <button class="like-button <%= 'liked' if current_user.already_liked?(@tweet) %>"
                data-tweet-id="<%= @tweet.id %>"
                data-like-id="<%= @tweet.likes.find_by(user_id: current_user.id)&.id %>">
        <svg class="heart-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
            <path d="m12 5.72c-2.624-4.517-10-3.198-10 2.461
                    0 3.725 4.345 7.727 9.303 12.54.194.189.446.283.697.283s.503-.094.697-.283
                    c4.977-4.831 9.303-8.814 9.303-12.54
                    0-5.678-7.396-6.944-10-2.461z"/>
        </svg>
        <span class="like-count"><%= @tweet.likes.count %></span>
        </button>
        <span class="comment-icon">üí¨ <%= @comments.count %></span>
    </div>

    <!-- Ë≥ºÂÖ•/„ÉÅ„É£„ÉÉ„Éà/Âá∫ÂìÅËÄÖË°®Á§∫ -->
    <% if user_signed_in? %>
        <% if @tweet.order.nil? %>
        <% if current_user.id != @tweet.user_id %>
            <%= button_to "Ë≥ºÂÖ•„Åô„Çã", orders_path(tweet_id: @tweet.id), method: :post, class: "btn btn-success" %>
        <% else %>
            <p>„Åì„Çå„ÅØ„ÅÇ„Å™„Åü„ÅÆÂá∫ÂìÅ„Åß„Åô„ÄÇ</p>
        <% end %>
        <% else %>
        <% if [@tweet.order.buyer_id, @tweet.user_id].include?(current_user.id) %>
            <%= link_to "„ÉÅ„É£„ÉÉ„ÉàÁîªÈù¢„Å∏", order_messages_path(@tweet.order), class: "chat-button" %>
            <% if current_user.id == @tweet.user_id %>
            <%= button_to "ÂèñÂºï„Çí‰∏≠Ê≠¢„Åô„Çã", order_path(@tweet.order), method: :delete, data: { confirm: "Êú¨ÂΩì„Å´ÂèñÂºï„Çí‰∏≠Ê≠¢„Åó„Åæ„Åô„ÅãÔºü" }, class: "btn btn-danger" %>
            <% end %>
        <% else %>
            <p>„Åì„ÅÆÂïÜÂìÅ„ÅØÂèñÂºï‰∏≠„Åß„Åô„ÄÇ</p>
        <% end %>
        <% end %>
    <% else %>
        <p>Ë≥ºÂÖ•„Éª„ÉÅ„É£„ÉÉ„ÉàÊ©üËÉΩ„Çí‰Ωø„ÅÜ„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ</p>
    <% end %>
    </div>
</div>

<!-- „Ç≥„É°„É≥„Éà„Çª„ÇØ„Ç∑„Éß„É≥ -->
<div class="comment-wrapper">
    <h3>„Ç≥„É°„É≥„Éà‰∏ÄË¶ß</h3>
    <% @comments.each do |comment| %>
    <div class="comment">
        <strong><%= comment.user.email %></strong><br>
        <%= comment.content %>
    </div>
    <% end %>

    <% if user_signed_in? %>
    <div class="comment-form">
        <%= form_with(model: [@tweet, Comment.new], local: true) do |form| %>
        <%= form.text_area :content, placeholder: "„Ç≥„É°„É≥„Éà„ÇíÊõ∏„Åè‚Ä¶" %>
        <%= form.submit "ÈÄÅ‰ø°", class: "comment-submit" %>
        <% end %>
    </div>
    <% end %>
</div>
</div>

<!-- „Éï„ÉÉ„Çø„Éº -->
<footer>
<div class="footer-content">
    <p>¬© 2025 HurimaApp</p>
</div>
</footer>

<!-- JavaScriptÔºö„ÅÑ„ÅÑ„Å≠Âá¶ÁêÜ -->
<script>
document.addEventListener("turbo:load", function() {
document.querySelectorAll(".like-button").forEach(button => {
    button.addEventListener("click", function(e) {
    e.preventDefault();
    const tweetId = this.dataset.tweetId;
    const likeId = this.dataset.likeId;
    const isLiked = this.classList.contains("liked");
    const method = isLiked ? "DELETE" : "POST";
    const url = isLiked ? `/tweets/${tweetId}/likes/${likeId}` : `/tweets/${tweetId}/likes`;
    const likeCountSpan = this.querySelector(".like-count");

    fetch(url, {
        method: method,
        headers: {
        "X-CSRF-Token": document.querySelector("meta[name=csrf-token]").content,
        "Content-Type": "application/json"
        },
        body: JSON.stringify({})
    }).then(res => {
        if (res.ok) {
        this.classList.toggle("liked");
        const count = parseInt(likeCountSpan.textContent);
        likeCountSpan.textContent = isLiked ? count - 1 : count + 1;

        const heart = this.querySelector(".heart-icon");
        heart.classList.remove("animate-pop");
        void heart.offsetWidth;
        heart.classList.add("animate-pop");

        if (isLiked) {
            this.dataset.likeId = "";
        } else {
            res.json().then(data => {
            this.dataset.likeId = data.like_id;
            });
        }
        }
    });
    });
});
});

document.addEventListener("turbo:load", function () {
    const toggleBtn = document.getElementById("toggle-tag-search");
    const tagBox = document.getElementById("tag-search-box");
    if (toggleBtn && tagBox) {
        toggleBtn.addEventListener("click", () => {
            tagBox.style.display = (tagBox.style.display === "none" || tagBox.style.display === "") ? "block" : "none";
        });
    }
});

</script>

</body>
</html>
